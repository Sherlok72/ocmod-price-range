<?xml version="1.0" encoding="utf-8"?>

<!--
This file is part of "Price Range+ eMarket" project and subject to the terms
and conditions defined in file "LICENSE.txt", which is part of this source
code package and also available on the project page: https://git.io/JvBbw.
-->


<modification>
	<name>[underr] Price Range+ eMarket</name>
	<code>price-range-plus-emarket</code>
	<version>1.0.0</version>
	<author>Andrii Burkatskyi aka underr</author>
	<link>https://git.io/JvBbw</link>

	<file path="catalog/controller/extension/module/{so_category_slider,so_deals,so_listing_tabs,so_super_category}.php" error="log">
		<operation error="log">
			<search><![CDATA[$cat['child'][]]]></search>
			<add position="before"><![CDATA[

				if ($this->config->get('module_price_range_status') && $this->config->get('module_price_range_store')[$this->config->get('config_store_id')]['status']) {
					$this->load->model('extension/module/price_range');

					$price_range = $this->model_extension_module_price_range->getPriceRange($product_info['product_id']);

					if (isset($price_range['price']) && $price) {
						$price = $price_range['price'];
					}

					if (isset($price_range['special']) && $special) {
						$product['special'] = $price_range['special'];
					}

					if (isset($price_range['tax']) && $tax) {
						$product['tax'] = $price_range['tax'];
					}
				}

			]]>
			</add>
		</operation>
	</file>

	<file path="catalog/controller/extension/module/{so_category_slider,so_deals}.php" error="log">
		<operation error="log">
			<search><![CDATA[$data['product_features'][]]]></search>
			<add position="before"><![CDATA[

				if ($this->config->get('module_price_range_status') && $this->config->get('module_price_range_store')[$this->config->get('config_store_id')]['status']) {
					$this->load->model('extension/module/price_range');

					$price_range = $this->model_extension_module_price_range->getPriceRange($product_info['product_id']);

					if (isset($price_range['price']) && $price) {
						$price = $price_range['price'];
					}

					if (isset($price_range['special']) && $special) {
						$product['special'] = $price_range['special'];
					}

					if (isset($price_range['tax']) && $tax) {
						$product['tax'] = $price_range['tax'];
					}
				}

			]]>
			</add>
		</operation>
	</file>

	<file path="catalog/controller/extension/module/{so_basic_products,so_extra_slider,so_filter_shop_by,so_quick_view}.php" error="log">
		<operation error="log">
			<search><![CDATA[$data['products'][]]]></search>
			<add position="before"><![CDATA[

				if ($this->config->get('module_price_range_status') && $this->config->get('module_price_range_store')[$this->config->get('config_store_id')]['status']) {
					$this->load->model('extension/module/price_range');

					$price_range = $this->model_extension_module_price_range->getPriceRange($product_info['product_id']);

					if (isset($price_range['price']) && $price) {
						$price = $price_range['price'];
					}

					if (isset($price_range['special']) && $special) {
						$product['special'] = $price_range['special'];
					}

					if (isset($price_range['tax']) && $tax) {
						$product['tax'] = $price_range['tax'];
					}
				}

			]]>
			</add>
		</operation>
	</file>

	<file path="catalog/controller/extension/module/{so_category_slider,so_deals,so_listing_tabs,so_super_category}.php" error="log">
		<operation error="log">
			<search><![CDATA[$cat['child'][]]]></search>
			<add position="before"><![CDATA[

				if ($this->config->get('module_price_range_status') && $this->config->get('module_price_range_store')[$this->config->get('config_store_id')]['status']) {
					$this->load->model('extension/module/price_range');

					$price_range = $this->model_extension_module_price_range->getPriceRange($product_info['product_id']);

					if (isset($price_range['price']) && $price) {
						$price = $price_range['price'];
					}

					if (isset($price_range['special']) && $special) {
						$product['special'] = $price_range['special'];
					}

					if (isset($price_range['tax']) && $tax) {
						$product['tax'] = $price_range['tax'];
					}
				}

			]]>
			</add>
		</operation>
	</file>

	<!-- This fix does not related to the "Price Range+" and was added just in case -->
	<file path="catalog/controller/extension/module/{so_super_category}.php" error="log">
		<operation error="log" info="url fix">
			<search><![CDATA[$this->url->link('product/product', 'product_id=' . $product_info['product_id'])]]></search>
			<add position="replace"><![CDATA[html_entity_decode($this->url->link('product/product', 'product_id=' . $product_info['product_id']))]]>
			</add>
		</operation>
	</file>

</modification>
